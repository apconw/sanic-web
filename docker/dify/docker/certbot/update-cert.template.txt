#!/bin/bash
set -e

DOMAIN="${CERTBOT_DOMAIN***REMOVED***"
EMAIL="${CERTBOT_EMAIL***REMOVED***"
OPTIONS="${CERTBOT_OPTIONS***REMOVED***"
CERT_NAME="${DOMAIN***REMOVED***" # 証明書名をドメイン名と同じにする

# Check if the certificate already exists
if [ -f "/etc/letsencrypt/renewal/${CERT_NAME***REMOVED***.conf" ]; then
  echo "Certificate exists. Attempting to renew..."
  certbot renew --noninteractive --cert-name ${CERT_NAME***REMOVED*** --webroot --webroot-path=/var/www/html --email ${EMAIL***REMOVED*** --agree-tos --no-eff-email ${OPTIONS***REMOVED***
else
  echo "Certificate does not exist. Obtaining a new certificate..."
  certbot certonly --noninteractive --webroot --webroot-path=/var/www/html --email ${EMAIL***REMOVED*** --agree-tos --no-eff-email -d ${DOMAIN***REMOVED*** ${OPTIONS***REMOVED***
fi
echo "Certificate operation successful"
# Note: Nginx reload should be handled outside this container
echo "Please ensure to reload Nginx to apply any certificate changes."
